<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>订单列表</title>
  <!-- 引入样式 -->
  <link rel="stylesheet" href="../../plugins/element-ui/index.css" />
</head>
<body>
<div id="order-list">
    <el-row style="margin-top: 40px">
        <el-input
            type="text"
            v-model="input"
            placeholder="请输入用户姓名"
            style="width: 250px">
        </el-input>
        <el-button type="primary" @click="init">搜索</el-button>
        <el-button
            type="warning"
            style="margin-left:1080px"
            @click="deleteOrders(checkList)">
        批量删除
        </el-button>
    </el-row>
    <el-table
          :data="tableData"
          style="width: 100%; margin-top: 20px"
          @selection-change="handleSelectionChange">

        <el-table-column
                type="selection"
                width="55">
        </el-table-column>

        <el-table-column
            prop="id"
            label="订单号"
            width="180">
        </el-table-column>

        <el-table-column
              prop="status"
              label="支付状态"
              width="180">
        </el-table-column>

        <el-table-column
            prop="userName"
            label="用户"
            width="180">
        </el-table-column>
        <el-table-column
            prop="phone"
            label="手机号"
            width="180">
        </el-table-column>

        <el-table-column
                prop="address"
                label="地址"
                width="180">
        </el-table-column>

        <el-table-column
            prop="orderTime"
            label="下单时间"
            width="180">
        </el-table-column>
        <el-table-column
            prop="checkoutTime"
            label="结算时间">
        </el-table-column>
        <el-table-column
            prop="money"
            label="订单金额"
            width="180">
        </el-table-column>

        <el-table-column
            label="操作"
            width="180">
      <template slot-scope="scope">
        <el-button
             type="danger"
             @click="deleteHandle(scope.row.id)"
        >
          删除
        </el-button>
      </template>
    </el-table-column>
  </el-table>

  <div class="block" style="margin-left: 600px">
    <el-pagination
            @size-change="handleSizeChange"
            @current-change="handleCurrentChange"
            :current-page="page"
            :page-sizes="[10,20,30,40]"
            :page-size="pageSize"
            layout="total, sizes, prev, pager, next, jumper"
            :total="counts">
    </el-pagination>
  </div>
</div>

<script src="../../plugins/vue/vue.js"></script>
<!-- 引入组件库 -->
<script src="../../plugins/element-ui/index.js"></script>
<!-- 引入axios -->
<script src="../../plugins/axios/axios.min.js"></script>
<script src="../../js/request.js"></script>
<script src="../../js/index.js"></script>
<script src="../../api/order.js"></script>

<script>
  new Vue({
    el: '#order-list',
    data() {
      return{
        input: '',
        page: 1,
        pageSize: 10,
        counts: 40,
        tableData: [],
        checkList: [],
      }
    },
    created(){
      this.init()
    },
    methods: {
        handleSelectionChange(val) {
            let checkArray = []
            val.forEach((n)=>{
                checkArray.push(n.id)
            })
            this.checkList = checkArray
        },
        toggleSelection(rows) {
            if (rows) {
                rows.forEach(row => {
                    this.$refs.multipleTable.toggleRowSelection(row);
                });
            } else {
                this.$refs.multipleTable.clearSelection();
            }
        },
      handleSizeChange(val) {
        this.pageSize = val
        this.init()
      },
      handleCurrentChange(val) {
        this.page = val
        this.init()
      },
      addTea() {
        window.location.href = "add.html"
      },
      async init(){
        const params ={
          page: this.page,
          pageSize: this.pageSize,
          userName: this.input ? this.input : undefined
        }
        await getOrderPage(params).then(res=>{
          if(String(res.code) === '1'){
            this.tableData = res.data.records || []
            this.counts = res.data.total
          }
        }).catch(err=>{
          this.$message.error("请求出错了" + err)
        })
      },
      deleteHandle(id) {
          let ids = {
              id: id
          }
          this.$confirm('确认删除该订单，是否继续？', '确认删除', {
              confirmButtonText: '确认',
              cancelButtonText: '取消'
          }).then(() => {
                  deleteOrder(ids).then(res => {
                      if (res.code === 1) {
                          this.$message.success('删除订单成功')
                          this.init()
                      }
                  })
              }
          )
      },

        deleteOrders(checkList){
            if(checkList.length ===0){
                this.$message.error('请选择要删除的订单')
            }
            else{
                this.$confirm('确认删除所选订单，是否继续？', '确认删除', {
                    confirmButtonText: '确认',
                    cancelButtonText: '取消'
                }).then(() => {
                batchDeleteOrder(checkList).then(res=>{
                if(res.code === 1){
                    this.$message.success('批量删除成功')
                    this.init()
                }
                })
                })
            }
        },
    }
  })
</script>
</body>
</html>